

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lab Deployment &mdash; terraform-iac-lab  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Validation Testing" href="validation.html" />
    <link rel="prev" title="Panorama Configuration" href="../02-configure/configure.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> terraform-iac-lab
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../00-overview/introduction.html">Lab Introduction</a></li>
</ul>
<p class="caption"><span class="caption-text">getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../01-getting-started/requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-getting-started/setup.html">Setup</a></li>
</ul>
<p class="caption"><span class="caption-text">configure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02-configure/terraform.html">Terraform Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02-configure/configure.html">Panorama Configuration</a></li>
</ul>
<p class="caption"><span class="caption-text">deploy</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-a-service-account-credential-file">Create a service account credential file</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-an-ssh-key-pair">Create an SSH key-pair</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-deployment-terraform-tfvars">Create deployment/terraform.tfvars</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-the-bootstrap-module">Add the bootstrap module</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-the-firewall-module">Add the firewall module</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deploy-the-infrastructure">Deploy the infrastructure</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="validation.html">Validation Testing</a></li>
</ul>
<p class="caption"><span class="caption-text">summary</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../05-summary/summary.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05-summary/cleanup.html">Cleaning Up</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05-summary/moreinfo.html">Further Reading</a></li>
</ul>
<p class="caption"><span class="caption-text">appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../06-appendix/terraform-commit.html">Terraform and Commits</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">terraform-iac-lab</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Lab Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/03-deploy/deploy.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lab-deployment">
<h1>Lab Deployment<a class="headerlink" href="#lab-deployment" title="Permalink to this headline">¶</a></h1>
<p>In this activity you will:</p>
<ul class="simple">
<li><p>Create a service account credential file</p></li>
<li><p>Create an SSH key-pair</p></li>
<li><p>Create the terraform.tfvars file</p></li>
<li><p>Add the bootstrap module</p></li>
<li><p>Add the firewall module</p></li>
<li><p>Deploy the infrastructure</p></li>
</ul>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The lab infrastructure will also be deployed in GCP using Terraform.  A Terraform plan has been provided that will
initialize the GCP provider, and call most of the modules responsible for creating the network, compute, and storage
resources needed.  You will add the modules for creating the bootstrap configuration as well as the VM-Series firewall.</p>
<p>First, change to the Terraform deployment directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/terraform-iac-lab/deployment
</pre></div>
</div>
</div>
<div class="section" id="create-a-service-account-credential-file">
<h2>Create a service account credential file<a class="headerlink" href="#create-a-service-account-credential-file" title="Permalink to this headline">¶</a></h2>
<p>Terraform will need to authenticate to GCP to perform the deployment.  We <em>could</em> authenticate to GCP using the
username presented in the Qwiklabs panel when the lab was started.  However, the Compute Engine default service
account is typically used because it is certain to have all the neccesary permissions.</p>
<p>List the email address of the Compute Engine default service account.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ gcloud iam service-accounts list
</pre></div>
</div>
<p>Use the following <code class="docutils literal notranslate"><span class="pre">gcloud</span></code> command to download the credentials for the <strong>Compute Engine default service account</strong>
using its associated email address (displayed in the output of the previous command).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ gcloud iam service-accounts keys create ~/gcp_compute_key.json --iam-account &lt;EMAIL_ADDRESS&gt;
</pre></div>
</div>
<p>Verify the JSON credentials file was successfully created.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cat ~/gcp_compute_key.json
</pre></div>
</div>
</div>
<div class="section" id="create-an-ssh-key-pair">
<h2>Create an SSH key-pair<a class="headerlink" href="#create-an-ssh-key-pair" title="Permalink to this headline">¶</a></h2>
<p>All Compute Engine instances are required to have an SSH key-pair defined when the instance is created.  This is done
to ensure secure access to the instance will be available once it is created.</p>
<p>Create an SSH key-pair with an empty passphrase and save them in the <code class="docutils literal notranslate"><span class="pre">~/.ssh</span></code> directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ssh-keygen -t rsa -b <span class="m">1024</span> -N <span class="s1">&#39;&#39;</span> -f ~/.ssh/lab_ssh_key
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>GCP has the ability to manage all of its own SSH keys and propagate
them automatically to projects and instances. However, the VM-Series
is only able to make use of a single SSH key. Rather than leverage
GCP’s SSH key management process, we’ve created our own SSH key and
configured Compute Engine to use our key exclusively.</p>
</div>
</div>
<div class="section" id="create-deployment-terraform-tfvars">
<h2>Create deployment/terraform.tfvars<a class="headerlink" href="#create-deployment-terraform-tfvars" title="Permalink to this headline">¶</a></h2>
<p>In this directory you will find the three main files associated with a Terraform plan: <code class="docutils literal notranslate"><span class="pre">main.tf</span></code>, <code class="docutils literal notranslate"><span class="pre">variables.tf</span></code>,
and <code class="docutils literal notranslate"><span class="pre">outputs.tf</span></code>.  View the contents of these files to see what they contain and how they’re structured.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ more main.tf
$ more variables.tf
$ more outputs.tf
</pre></div>
</div>
<p>The file <code class="docutils literal notranslate"><span class="pre">main.tf</span></code> defines the providers that will be used and the resources that will be created (more on that
shortly).  Since it is poor practice to hard code values into the plan, the file <code class="docutils literal notranslate"><span class="pre">variables.tf</span></code> will be used to
declare the variables that will be used in the plan (but not necessarily their values).  The <code class="docutils literal notranslate"><span class="pre">outputs.tf</span></code> file
will define the values to display that result from applying the plan.</p>
<p>Create a file called <code class="docutils literal notranslate"><span class="pre">terraform.tfvars</span></code> in the current directory that contains the following variables and their
values.  You will need to add a number of things:</p>
<p><strong>GCP configuration:</strong></p>
<dl class="simple">
<dt>project:</dt><dd><p>The GCP project ID to use.</p>
</dd>
<dt>region:</dt><dd><p>The GCP region we are using.</p>
</dd>
<dt>zone:</dt><dd><p>The GCP zone we are using.</p>
</dd>
</dl>
<p><strong>Authentication information</strong></p>
<dl class="simple">
<dt>credentials_file:</dt><dd><p>Path to the JSON credentials file.</p>
</dd>
<dt>public_key_file:</dt><dd><p>Path to the SSH public key file.</p>
</dd>
</dl>
<p><strong>Firewall information:</strong></p>
<dl class="simple">
<dt>fw_name:</dt><dd><p>The name for the firewall.</p>
</dd>
</dl>
<p><strong>Panorama bootstrap information:</strong></p>
<dl class="simple">
<dt>panorama:</dt><dd><p>The hostname/IP address of Panorama.</p>
</dd>
<dt>tplname:</dt><dd><p>The template stack created in the previous section (replace XX with your
student number).</p>
</dd>
<dt>dgname:</dt><dd><p>The device group created in the previous section (replace XX with your
student number).</p>
</dd>
<dt>vm_auth_key:</dt><dd><p>The VM auth key for Panorama.</p>
</dd>
</dl>
<p>Your file should look similar to the following, with the appropriate values replaced:</p>
<div class="highlight-terraform notranslate"><div class="highlight"><pre><span></span><span class="na">project</span>             <span class="o">=</span> <span class="s2">&quot;&lt;YOUR_GCP_PROJECT_ID&gt;&quot;</span>
<span class="na">region</span>              <span class="o">=</span> <span class="s2">&quot;&lt;SEE_INSTRUCTOR_PRESENTATION&gt;&quot;</span>
<span class="na">zone</span>                <span class="o">=</span> <span class="s2">&quot;&lt;SEE_INSTRUCTOR_PRESENTATION&gt;&quot;</span>
<span class="na">credentials_file</span>    <span class="o">=</span> <span class="s2">&quot;~/gcp_compute_key.json&quot;</span>
<span class="na">public_key_file</span>     <span class="o">=</span> <span class="s2">&quot;~/.ssh/lab_ssh_key.pub&quot;</span>

<span class="na">fw_name</span>     <span class="o">=</span> <span class="s2">&quot;studentXX-fw&quot;</span>
<span class="na">panorama</span>    <span class="o">=</span> <span class="s2">&quot;&lt;SEE_INSTRUCTOR_PRESENTATION&gt;&quot;</span>
<span class="na">tplname</span>     <span class="o">=</span> <span class="s2">&quot;studentXX-stack&quot;</span>
<span class="na">dgname</span>      <span class="o">=</span> <span class="s2">&quot;studentXX-dg&quot;</span>
<span class="na">vm_auth_key</span> <span class="o">=</span> <span class="s2">&quot;&lt;SEE_INSTRUCTOR_PRESENTATION&gt;&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’re running this lab on your own, replace these values appropriately.
See the Panorama documentation for generating the VM auth key.</p>
</div>
</div>
<div class="section" id="add-the-bootstrap-module">
<h2>Add the bootstrap module<a class="headerlink" href="#add-the-bootstrap-module" title="Permalink to this headline">¶</a></h2>
<p>Add the following module definition to <code class="docutils literal notranslate"><span class="pre">deployment/main.tf</span></code>:</p>
<div class="highlight-terraform notranslate"><div class="highlight"><pre><span></span><span class="kr">module</span> <span class="s">&quot;bootstrap&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    source</span>  <span class="o">=</span> <span class="s2">&quot;PaloAltoNetworks/panos-bootstrap/google&quot;</span>
<span class="na">    version</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>

<span class="na">    bootstrap_project</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">project</span>
<span class="na">    bootstrap_region</span>  <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">region</span>

<span class="na">    hostname</span>        <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">fw_name</span>
<span class="na">    panorama-server</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">panorama</span>
<span class="na">    tplname</span>         <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">tplname</span>
<span class="na">    dgname</span>          <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">dgname</span>
<span class="na">    vm-auth-key</span>     <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">vm_auth_key</span>
<span class=" -Punctuation">}</span>
</pre></div>
</div>
<p>This uses a module that has been published to the Terraform module registry for public use.  (If you’d like to review
the code, it’s on the
<a class="reference external" href="https://github.com/PaloAltoNetworks/terraform-google-panos-bootstrap">PaloAltoNetworks GitHub page</a>.) This will
create the Google Storage bucket for holding a PAN-OS bootstrap configuration, as well as
<a class="reference external" href="https://docs.paloaltonetworks.com/vm-series/10-0/vm-series-deployment/bootstrap-the-vm-series-firewall.html">the required files</a>.</p>
</div>
<div class="section" id="add-the-firewall-module">
<h2>Add the firewall module<a class="headerlink" href="#add-the-firewall-module" title="Permalink to this headline">¶</a></h2>
<p>Now we need to add another module definition to <code class="docutils literal notranslate"><span class="pre">deployment/main.tf</span></code> to specify the firewall configuration:</p>
<div class="highlight-terraform notranslate"><div class="highlight"><pre><span></span><span class="kr">module</span> <span class="s">&quot;firewall&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    source</span> <span class="o">=</span> <span class="s2">&quot;./modules/firewall&quot;</span>

<span class="na">    fw_name</span>             <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">fw_name</span>
<span class="na">    fw_zone</span>             <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">zone</span>
<span class="na">    fw_image</span>            <span class="o">=</span> <span class="s2">&quot;https://www.googleapis.com/compute/v1/projects/paloaltonetworksgcp-public/global/images/vmseries-flex-bundle2-1000&quot;</span>
<span class="na">    fw_machine_type</span>     <span class="o">=</span> <span class="s2">&quot;n1-standard-4&quot;</span>
<span class="na">    fw_machine_cpu</span>      <span class="o">=</span> <span class="s2">&quot;Intel Skylake&quot;</span>
<span class="na">    fw_bootstrap_bucket</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">bootstrap</span><span class="p">.</span><span class="err">bootstrap_name</span>

<span class="na">    fw_ssh_key</span> <span class="o">=</span> <span class="s2">&quot;admin:${file(var.public_key_file)}&quot;</span>

<span class="na">    fw_mgmt_subnet</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">mgmt_subnet</span>
<span class="na">    fw_mgmt_ip</span>     <span class="o">=</span> <span class="s2">&quot;10.5.0.4&quot;</span>
<span class="na">    fw_mgmt_rule</span>   <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">mgmt-allow-inbound-rule</span>

<span class="na">    fw_untrust_subnet</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">untrust_subnet</span>
<span class="na">    fw_untrust_ip</span>     <span class="o">=</span> <span class="s2">&quot;10.5.1.4&quot;</span>
<span class="na">    fw_untrust_rule</span>   <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">untrust-allow-inbound-rule</span>

<span class="na">    fw_web_subnet</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">web_subnet</span>
<span class="na">    fw_web_ip</span>     <span class="o">=</span> <span class="s2">&quot;10.5.2.4&quot;</span>
<span class="na">    fw_web_rule</span>   <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">web-allow-outbound-rule</span>

<span class="na">    fw_db_subnet</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">db_subnet</span>
<span class="na">    fw_db_ip</span>     <span class="o">=</span> <span class="s2">&quot;10.5.3.4&quot;</span>
<span class="na">    fw_db_rule</span>   <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">db-allow-outbound-rule</span>
<span class=" -Punctuation">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/PaloAltoNetworks/terraform-iac-lab/blob/master/deployment/modules/firewall/main.tf">This module</a>
creates the VM-Series instance.  Notice how the outputs from the <em>bootstrap</em> and <em>vpc</em> modules are used as inputs to
this one.</p>
</div>
<div class="section" id="deploy-the-infrastructure">
<h2>Deploy the infrastructure<a class="headerlink" href="#deploy-the-infrastructure" title="Permalink to this headline">¶</a></h2>
<p>Your completed <code class="docutils literal notranslate"><span class="pre">deployment/main.tf</span></code> file should look like this:</p>
<div class="highlight-terraform notranslate"><div class="highlight"><pre><span></span><span class="kr">provider</span> <span class="s">&quot;google&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    credentials</span> <span class="o">=</span> <span class="err">file</span><span class="p">(</span><span class="err">var</span><span class="p">.</span><span class="err">credentials_file</span><span class="p">)</span>
<span class="na">    project</span>     <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">project</span>
<span class="na">    region</span>      <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">region</span>
<span class=" -Punctuation">}</span>

<span class="kr">module</span> <span class="s">&quot;bootstrap&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    source</span>  <span class="o">=</span> <span class="s2">&quot;PaloAltoNetworks/panos-bootstrap/google&quot;</span>
<span class="na">    version</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>

<span class="na">    bootstrap_project</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">project</span>
<span class="na">    bootstrap_region</span>  <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">region</span>

<span class="na">    hostname</span>        <span class="o">=</span> <span class="s2">&quot;terraform-iac-fw&quot;</span>
<span class="na">    panorama-server</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">panorama</span>
<span class="na">    tplname</span>         <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">tplname</span>
<span class="na">    dgname</span>          <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">dgname</span>
<span class="na">    vm-auth-key</span>     <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">vm_auth_key</span>
<span class=" -Punctuation">}</span>

<span class="kr">module</span> <span class="s">&quot;vpc&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    source</span> <span class="o">=</span> <span class="s2">&quot;./modules/vpc&quot;</span>

<span class="na">    vpc_region</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">region</span>

<span class="na">    vpc_mgmt_network_name</span> <span class="o">=</span> <span class="s2">&quot;management-network&quot;</span>
<span class="na">    vpc_mgmt_subnet_cidr</span>  <span class="o">=</span> <span class="s2">&quot;10.5.0.0/24&quot;</span>
<span class="na">    vpc_mgmt_subnet_name</span>  <span class="o">=</span> <span class="s2">&quot;management-subnet&quot;</span>

<span class="na">    vpc_untrust_network_name</span> <span class="o">=</span> <span class="s2">&quot;untrust-network&quot;</span>
<span class="na">    vpc_untrust_subnet_cidr</span>  <span class="o">=</span> <span class="s2">&quot;10.5.1.0/24&quot;</span>
<span class="na">    vpc_untrust_subnet_name</span>  <span class="o">=</span> <span class="s2">&quot;untrust-subnet&quot;</span>

<span class="na">    vpc_web_network_name</span> <span class="o">=</span> <span class="s2">&quot;web-network&quot;</span>
<span class="na">    vpc_web_subnet_cidr</span>  <span class="o">=</span> <span class="s2">&quot;10.5.2.0/24&quot;</span>
<span class="na">    vpc_web_subnet_name</span>  <span class="o">=</span> <span class="s2">&quot;web-subnet&quot;</span>

<span class="na">    vpc_db_network_name</span> <span class="o">=</span> <span class="s2">&quot;database-network&quot;</span>
<span class="na">    vpc_db_subnet_cidr</span>  <span class="o">=</span> <span class="s2">&quot;10.5.3.0/24&quot;</span>
<span class="na">    vpc_db_subnet_name</span>  <span class="o">=</span> <span class="s2">&quot;database-subnet&quot;</span>

<span class="na">    allowed_mgmt_cidr</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">allowed_mgmt_cidr</span>
<span class=" -Punctuation">}</span>

<span class="kr">module</span> <span class="s">&quot;web&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    source</span> <span class="o">=</span> <span class="s2">&quot;./modules/web&quot;</span>

<span class="na">    web_name</span>         <span class="o">=</span> <span class="s2">&quot;web-vm&quot;</span>
<span class="na">    web_zone</span>         <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">zone</span>
<span class="na">    web_machine_type</span> <span class="o">=</span> <span class="s2">&quot;n1-standard-1&quot;</span>
<span class="na">    web_ssh_key</span>      <span class="o">=</span> <span class="s2">&quot;admin:${file(var.public_key_file)}&quot;</span>
<span class="na">    web_subnet_id</span>    <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">web_subnet</span>
<span class="na">    web_ip</span>           <span class="o">=</span> <span class="s2">&quot;10.5.2.5&quot;</span>
<span class="na">    web_image</span>        <span class="o">=</span> <span class="s2">&quot;debian-9&quot;</span>
<span class=" -Punctuation">}</span>

<span class="kr">module</span> <span class="s">&quot;db&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    source</span> <span class="o">=</span> <span class="s2">&quot;./modules/db&quot;</span>

<span class="na">    db_name</span>         <span class="o">=</span> <span class="s2">&quot;db-vm&quot;</span>
<span class="na">    db_zone</span>         <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">zone</span>
<span class="na">    db_machine_type</span> <span class="o">=</span> <span class="s2">&quot;n1-standard-1&quot;</span>
<span class="na">    db_ssh_key</span>      <span class="o">=</span> <span class="s2">&quot;admin:${file(var.public_key_file)}&quot;</span>
<span class="na">    db_subnet_id</span>    <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">db_subnet</span>
<span class="na">    db_ip</span>           <span class="o">=</span> <span class="s2">&quot;10.5.3.5&quot;</span>
<span class="na">    db_image</span>        <span class="o">=</span> <span class="s2">&quot;debian-9&quot;</span>
<span class=" -Punctuation">}</span>

<span class="kr">module</span> <span class="s">&quot;firewall&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    source</span> <span class="o">=</span> <span class="s2">&quot;./modules/firewall&quot;</span>

<span class="na">    fw_name</span>             <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">fw_name</span>
<span class="na">    fw_zone</span>             <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">zone</span>
<span class="na">    fw_image</span>            <span class="o">=</span> <span class="s2">&quot;https://www.googleapis.com/compute/v1/projects/paloaltonetworksgcp-public/global/images/vmseries-flex-bundle2-1000&quot;</span>
<span class="na">    fw_machine_type</span>     <span class="o">=</span> <span class="s2">&quot;n1-standard-4&quot;</span>
<span class="na">    fw_machine_cpu</span>      <span class="o">=</span> <span class="s2">&quot;Intel Skylake&quot;</span>
<span class="na">    fw_bootstrap_bucket</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">bootstrap</span><span class="p">.</span><span class="err">bootstrap_name</span>

<span class="na">    fw_ssh_key</span> <span class="o">=</span> <span class="s2">&quot;admin:${file(var.public_key_file)}&quot;</span>

<span class="na">    fw_mgmt_subnet</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">mgmt_subnet</span>
<span class="na">    fw_mgmt_ip</span>     <span class="o">=</span> <span class="s2">&quot;10.5.0.4&quot;</span>
<span class="na">    fw_mgmt_rule</span>   <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">mgmt-allow-inbound-rule</span>

<span class="na">    fw_untrust_subnet</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">untrust_subnet</span>
<span class="na">    fw_untrust_ip</span>     <span class="o">=</span> <span class="s2">&quot;10.5.1.4&quot;</span>
<span class="na">    fw_untrust_rule</span>   <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">untrust-allow-inbound-rule</span>

<span class="na">    fw_web_subnet</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">web_subnet</span>
<span class="na">    fw_web_ip</span>     <span class="o">=</span> <span class="s2">&quot;10.5.2.4&quot;</span>
<span class="na">    fw_web_rule</span>   <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">web-allow-outbound-rule</span>

<span class="na">    fw_db_subnet</span> <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">db_subnet</span>
<span class="na">    fw_db_ip</span>     <span class="o">=</span> <span class="s2">&quot;10.5.3.4&quot;</span>
<span class="na">    fw_db_rule</span>   <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">db-allow-outbound-rule</span>
<span class=" -Punctuation">}</span>

<span class="kr">resource</span> <span class="s">&quot;google_compute_route&quot; &quot;web-route&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    name</span>                   <span class="o">=</span> <span class="s2">&quot;web-route&quot;</span>
<span class="na">    dest_range</span>             <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
<span class="na">    network</span>                <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">web_network</span>
<span class="na">    next_hop_instance</span>      <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">firewall</span><span class="p">.</span><span class="err">firewall-instance</span>
<span class="na">    next_hop_instance_zone</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">zone</span>
<span class="na">    priority</span>               <span class="o">=</span> <span class="m">100</span>
<span class=" -Punctuation">}</span>

<span class="kr">resource</span> <span class="s">&quot;google_compute_route&quot; &quot;db-route&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    name</span>                   <span class="o">=</span> <span class="s2">&quot;db-route&quot;</span>
<span class="na">    dest_range</span>             <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
<span class="na">    network</span>                <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">vpc</span><span class="p">.</span><span class="err">db_network</span>
<span class="na">    next_hop_instance</span>      <span class="o">=</span> <span class="kr">module</span><span class="p">.</span><span class="err">firewall</span><span class="p">.</span><span class="err">firewall-instance</span>
<span class="na">    next_hop_instance_zone</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">zone</span>
<span class="na">    priority</span>               <span class="o">=</span> <span class="m">100</span>
<span class=" -Punctuation">}</span>
</pre></div>
</div>
<p>Now, you’re ready to deploy the infrastructure.  Run the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ terraform init
$ terraform plan
$ terraform apply
</pre></div>
</div>
<p>As we saw before, <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">init</span></code> will install all required providers and modules, <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">plan</span></code> will show all
the infrastructure that will be created, and <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">apply</span></code> will create the infrastructure.</p>
<p>At a high level, the completed Terraform configuration will:</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>Run the <code class="docutils literal notranslate"><span class="pre">bootstrap</span></code> module</dt><dd><ol class="arabic simple">
<li><p>Create a GCP storage bucket for the firewall bootstrap package</p></li>
<li><p>Apply a policy to the bucket allowing read access to <code class="docutils literal notranslate"><span class="pre">allUsers</span></code></p></li>
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">/config/init-cfg.txt</span></code>, <code class="docutils literal notranslate"><span class="pre">/config/bootstrap.xml</span></code>,
<code class="docutils literal notranslate"><span class="pre">/software</span></code>, <code class="docutils literal notranslate"><span class="pre">/content</span></code>, and <code class="docutils literal notranslate"><span class="pre">/license</span></code> objects in the bootstrap
bucket</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Run the <code class="docutils literal notranslate"><span class="pre">vpc</span></code> module</dt><dd><ol class="arabic simple">
<li><p>Create the VPC</p></li>
<li><p>Create the Internet gateway</p></li>
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">management</span></code>, <code class="docutils literal notranslate"><span class="pre">untrust</span></code>, <code class="docutils literal notranslate"><span class="pre">web</span></code>, and <code class="docutils literal notranslate"><span class="pre">database</span></code>
subnets</p></li>
<li><p>Create the security groups for each subnet</p></li>
<li><p>Create the default route for the <code class="docutils literal notranslate"><span class="pre">web</span></code> and <code class="docutils literal notranslate"><span class="pre">database</span></code> subnets</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Run the <code class="docutils literal notranslate"><span class="pre">firewall</span></code> module</dt><dd><ol class="arabic simple">
<li><p>Create the VM-Series firewall instance</p></li>
<li><p>Create the VM-Series firewall interfaces</p></li>
<li><p>Create the public IPs for the <code class="docutils literal notranslate"><span class="pre">management</span></code> and <code class="docutils literal notranslate"><span class="pre">untrust</span></code> interfaces</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Run the <code class="docutils literal notranslate"><span class="pre">web</span></code> module</dt><dd><ol class="arabic simple">
<li><p>Create the web server instance</p></li>
<li><p>Create the web server interface</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Run the <code class="docutils literal notranslate"><span class="pre">database</span></code> module</dt><dd><ol class="arabic simple">
<li><p>Create the database server instance</p></li>
<li><p>Create the database server interface</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
<p>The deployment process should finish in a few minutes and you will be presented with the public IP addresses of the
VM-Series firewall management and untrust interfaces.  However, the VM-Series firewall can take up to <em>ten minutes</em> to
complete the initial bootstrap process.</p>
<p>Once the firewall has completed the bootstrap process, it should be listed in Panorama as a managed device in your
device group under Panorama &gt; Managed Devices &gt; Summary.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="validation.html" class="btn btn-neutral float-right" title="Validation Testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../02-configure/configure.html" class="btn btn-neutral float-left" title="Panorama Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Palo Alto Networks

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>